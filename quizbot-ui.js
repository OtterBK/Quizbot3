// ÌïÑÏöîÌïú Ïô∏Î∂Ä Î™®Îìà
const { ActionRowBuilder, ButtonBuilder, ButtonStyle, Events, StringSelectMenuBuilder } = require('discord.js');
const { interaction } = require('lodash');
const cloneDeep = require("lodash/cloneDeep.js");
const fs = require('fs');
const { FORMERR } = require('dns');

//Î°úÏª¨ modules
const text_contents = require('./text_contents.json')["kor"]; //ÌïúÍµ≠Ïñ¥Î°ú Í∞ÄÏ†∏ÏôÄÏÑú ÏÇ¨Ïö©
const quiz_machine = require('./quiz_system.js'); //ÌÄ¥Ï¶àÎ¥á Î©îÏù∏ ÏãúÏä§ÌÖú
const GAME_TYPE = require('./game_type.json');


/** ÏÇ¨Ï†Ñ Ï†ïÏùò UIÎì§ */
const select_btn_row = new ActionRowBuilder()
.addComponents(
  new ButtonBuilder()
    .setCustomId('1')
    // .setLabel('1Ô∏è‚É£')
    .setLabel('1')
    .setStyle(ButtonStyle.Primary),
  new ButtonBuilder()
    .setCustomId('2')
    // .setLabel('2Ô∏è‚É£')
    .setLabel('2')
    .setStyle(ButtonStyle.Primary),
  new ButtonBuilder()
    .setCustomId('3')
    // .setLabel('3Ô∏è‚É£')
    .setLabel('3')
    .setStyle(ButtonStyle.Primary),
  new ButtonBuilder()
    .setCustomId('4')
    // .setLabel('4Ô∏è‚É£')
    .setLabel('4')
    .setStyle(ButtonStyle.Primary),
  new ButtonBuilder()
    .setCustomId('5')
    // .setLabel('5Ô∏è‚É£')
    .setLabel('5')
    .setStyle(ButtonStyle.Primary),
)

const control_btn_row = new ActionRowBuilder()
.addComponents(
  new ButtonBuilder()
  .setCustomId('prev')
  .setLabel('Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ')
  .setStyle(ButtonStyle.Secondary),
  new ButtonBuilder()
    .setCustomId('back')
    .setLabel('Îí§Î°úÍ∞ÄÍ∏∞')
    .setStyle(ButtonStyle.Secondary),
  new ButtonBuilder()
    .setCustomId('next')
    .setLabel('Îã§Ïùå ÌéòÏù¥ÏßÄ')
    .setStyle(ButtonStyle.Secondary),
)

//main embed Ïù∏Ïä§ÌÑ¥Ïä§ Î∞òÌôò
exports.createUIHolder = (interaction) => {

    return new UIHolder(interaction);

};


// UIÎì§ ÌëúÏãúÌï¥Ï£ºÎäî ÌôÄÎçî
class UIHolder 
{

  constructor(interaction)
  {
    this.base_interaction = interaction;
    this.guild = interaction.guild;
    this.guild_id = interaction.guild.id;
    this.ui = new MainUI();

    this.prev_ui_stack = [];

    this.base_interaction.reply( {embeds: [this.getUIEmbed()], components: this.getComponents()} );
  }

  getUI()
  {
    return this.ui;
  }

  getUIEmbed()
  {
    return this.ui.embed;
  }

  getUIComponents()
  {
    return this.ui.components;
  }

  //Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
  on(event_name, event_object)
  {

    if(event_name == "interactionCreate")
    {
      let interaction = event_object;
      if(interaction.isButton() && interaction.customId == "back" && this.prev_ui_stack.length > 0) //Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº Ï≤òÎ¶¨
      {
        this.ui = this.prev_ui_stack.pop();
        this.updateUI();
        return;
      }
    }

    let newUI = this.ui.on(event_name, event_object); //UIÍ∞Ä ÏÉàÎ°ú Î≥ÄÍ≤ΩÎêêÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏßÑÌñâ
    if(newUI != undefined)
    {
      if(this.ui != newUI) //ui stack Ïóê ÏåìÎäî Í≤ÉÏùÄ ÏÉà UIÍ∞Ä ÏÉùÏÑ±ÎêêÏùÑ ÎïåÎßå
      {
        this.prev_ui_stack.push(this.ui);
        this.ui = newUI;
      }
      this.updateUI();
    }
  }

  //UI Ïû¨Ï†ÑÏÜ°
  updateUI()
  {
    this.base_interaction.editReply( {embeds: [this.getUIEmbed()], components: this.getUIComponents()} );
  }

}

//QuizBotUI Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
class QuizbotUI {

  constructor()
  {
    this.embed = {

    }
    // this.components = [cloneDeep(select_btn_row), cloneDeep(control_btn_row)]; //ÎÇ¥Í∞Ä clonedeepÏùÑ Ïôú Ìï¥Ï§¨ÏßÄ?
    this.components = [select_btn_row, control_btn_row]; //Ïù¥Í≤å Í∏∞Î≥∏ componentÏûÑ
  }

  //Í∞Å ui Î≥Ñ onÏùÄ ÌïÑÏàò Íµ¨ÌòÑ ÌïÑÏöî
  on(event_name, event_object)
  {
    let newUI = undefined;

    switch(event_name)
    {
      case "interactionCreate":
        newUI = this.onInteractionCreate(event_object); break;
      
    }

    return newUI;
  }
  
}

//Î©îÏù∏Î©îÎâ¥
class MainUI extends QuizbotUI 
{

  constructor()
  {
    super();

    this.embed = {
      color: 0x87CEEB,
      title: text_contents.main_menu.title,
      url: text_contents.main_menu.url,
      author: {
      //   name: 'üìó Î©îÏù∏Î©îÎâ¥',
      //   icon_url: 'https://i.imgur.com/AfFp7pu.png',
      //   url: 'https://user-images.githubusercontent.com/28488288/106536426-c48d4300-653b-11eb-97ee-445ba6bced9b.jpg',
      },
      description: text_contents.main_menu.description,
      thumbnail: {
        url: 'https://user-images.githubusercontent.com/28488288/106536426-c48d4300-653b-11eb-97ee-445ba6bced9b.jpg',
      },
      fields: [
        // {
        //   name: 'Regular field title',
        //   value: 'Some value here',
        // },
        {
          name: '\u200b',
          value: '\u200b',
          inline: false,
        },
        {
          name: text_contents.main_menu.total_server,
          value: 'üíª 30', //TODO ÌîåÎ†àÏù¥Ïñ¥ Ïàò Ï†úÎåÄÎ°ú ÌëúÏãúÌï† Í≤É
          inline: true,
        },
        {
          name: text_contents.main_menu.playing_server,
          value: 'üïπ 10',
          inline: true,
        },
        {
          name: text_contents.main_menu.competitive_server,
          value: 'üåé 20',
          inline: true,
        },
      ],
      image: {
        url: '',
      },
      // timestamp: new Date().toISOString(),
      // footer: {
      //   text: 'Ï†úÏú°Î≥¥ÎÅî#1916',
      //   icon_url: 'https://user-images.githubusercontent.com/28488288/208116143-24828069-91e7-4a67-ac69-3bf50a8e1a02.png',
      // },
    };
  }

  onInteractionCreate(interaction)
  {
    if(!interaction.isButton()) return;

    if(interaction.customId == '1') //Î°úÏª¨ÌîåÎ†àÏù¥ ÎàåÎ†ÄÏùÑ Îïå
    {
      return new SelectQuizTypeUI();
    }
  }

}

//ÌÄ¥Ï¶à Ïú†Ìòï(Í∞úÎ∞úÏûê/Ïú†Ï†Ä) ÏÑ†ÌÉù UI
class SelectQuizTypeUI extends QuizbotUI {

  constructor()
  {
    super();

    this.embed = {
      color: 0x87CEEB,
      title: text_contents.select_quiz_type.title,
      url: text_contents.select_quiz_type.url,
      description: text_contents.select_quiz_type.description,
      thumbnail: {
        url: text_contents.select_quiz_type.thumbnail.url,
      },
    };
  }

  onInteractionCreate(interaction)
  {
    if(!interaction.isButton()) return;

    if(interaction.customId == '1') //Í∞úÎ∞úÏûê ÌÄ¥Ï¶à ÎàåÎ†ÄÏùÑ Îïå
    {
      return new DevQuizSelectUI();
    }
  }

}

//Í∞úÎ∞úÏûê ÌÄ¥Ï¶à ÏÑ†ÌÉù UI
class DevQuizSelectUI extends QuizbotUI  
{

  static resource_path = process.cwd() + "/resources/quizdata/";
  static quiz_contents = DevQuizSelectUI.loadLocalDirectoryQuiz(DevQuizSelectUI.resource_path); //ÎèôÏ†Å Î°úÎìúÌï† ÌïÑÏöîÎäî Îî±Ìûà ÏóÜÏùÑÎìØ..?

  constructor()
  {
    super();

    this.embed = {
      color: 0x87CEEB,
      title: text_contents.dev_select_category.title,
      url: text_contents.dev_select_category.url,
      description: text_contents.dev_select_category.description,
      thumbnail: {
        url: text_contents.dev_select_category.thumbnail.url,
      },
    };

    this.cur_contents = DevQuizSelectUI.quiz_contents;

    this.count_per_page = 5; //ÌéòÏù¥ÏßÄÎ≥Ñ ÌëúÏãúÌï† Ïª®ÌÖêÏ∏† Ïàò
    this.cur_page = 0;
    this.total_page = 0;
    this.showPage(this.cur_page);

  }

  static loadLocalDirectoryQuiz(content_path) 
  {
    let file_list = fs.readdirSync(content_path);

    let quiz_contents = [];
    file_list.forEach(file => {

      let quiz_content = DevQuizSelectUI.parseContentInfoFromDirName(file);

      // ÌïòÏúÑ Ïª®ÌÖêÏ∏† ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä ÌååÏã± ÏßÑÌñâ
      const file_path = content_path + file;
      const file_path_dir = file_path + "/"
      quiz_content['content_path'] = file_path;

      const is_quiz = quiz_content['is_quiz'];

      if(is_quiz == false)
      {
        const stat = fs.lstatSync(file_path);
        if(!stat.isFile()) //Ìè¥ÎçîÎ©¥ ÌïòÏúÑ ÎîîÎ†âÌÑ∞Î¶¨ ÏùΩÏñ¥Ïò¥
        {
          quiz_content['sub_contents'] = DevQuizSelectUI.loadLocalDirectoryQuiz(file_path_dir);
        }
      }
      else
      {
        //ÌÄ¥Ï¶àÎ©¥ info.txt ÏùΩÏñ¥Ïò¥
        const content_path_dir = content_path + "/";
        const quiz_list = fs.readdirSync(content_path_dir);

        let quiz_size = 0;
        quiz_list.forEach(quiz_file => {

          if(quiz_file.includes("info.txt") == false)
          {
            quiz_size += 1;
            return;
          }

          //info.txt ÌååÏã±... ÎÇú Ïôú Ïù¥Îü∞ Î∞©ÏãùÏùÑ ÏÇ¨Ïö©ÌñàÎçòÍ±∏Íπå..?
          const info_txt_path = content_path_dir + quiz_file;
          const info_data = fs.readFileSync(info_txt_path, 'utf8');

          let winner_nickname_tmp = info_data.split('&topNickname: ');
          if(winner_nickname_tmp.length > 1)
          {
            quiz_content['winner_nickname'] = winner_nickname_tmp[1].split("&");
          }

          let typeName_tmp = info_data.split('&topNickname: ');
          if(typeName_tmp.length > 1)
          {
            quiz_content['type_name'] = typeName_tmp[1].split("&");
          }

        });

        //ÏïÑÏù¥ÏΩòÏúºÎ°ú ÌÄ¥Ï¶à ÌÉÄÏûÖ Í∞ÄÏ†∏Ïò§Í∏∞... ÏòàÏ†ÑÏóê ÏûêÏã†ÏùÑ ÏõêÎßùÌïòÏûê
        const quiz_icon = quiz_content['icon'];

        if(quiz_icon == text_contents.icon.ICON_TYPE_SONG)
            quiz_content['game_type'] = GAME_TYPE.SONG
        else if(quiz_icon == text_contents.icon.ICON_TYPE_PICTURE)
            quiz_content['game_type'] = GAME_TYPE.PICTURE
        else if(quiz_icon == text_contents.icon.ICON_TYPE_PICTURE_LONG)
            quiz_content['game_type'] = GAME_TYPE.PICTURE_LONG
        else if(quiz_icon == text_contents.icon.ICON_TYPE_OX)
            quiz_content['game_type'] = GAME_TYPE.OX
        else if(quiz_icon == text_contents.icon.ICON_TYPE_INTRO)
            quiz_content['game_type'] = GAME_TYPE.INTRO
        else if(quiz_icon == text_contents.icon.ICON_TYPE_QNA)
            quiz_content['game_type'] = GAME_TYPE.QNA
        else if(quiz_icon == text_contents.icon.ICON_TYPE_SCRIPT)
            quiz_content['game_type'] = GAME_TYPE.SCRIPT
        else if(quiz_icon == text_contents.icon.ICON_TYPE_SELECT)
            quiz_content['game_type'] = GAME_TYPE.SELECT
        else if(quiz_icon == text_contents.icon.ICON_TYPE_MULTIPLAY)
            quiz_content['game_type'] = GAME_TYPE.MULTIPLAY
        else quiz_content['game_type'] = GAME_TYPE.SONG


        // ÌÄ¥Ï¶à Ïàò
        quiz_content['quiz_size'] = quiz_size;

      }

      quiz_contents.push(quiz_content);

    })

    return quiz_contents;
  }

  static parseContentInfoFromDirName(file_name)
  {
    let content = {};

    content['name'] = file_name.split("&")[0];

    let icon = file_name.split("icon="); //ICON Îßå ÌååÏã±
    if(icon.length > 1) //icon= Ïù¥ ÏûàÎã§Î©¥
      content['icon'] = icon[1].split("&")[0];
    else 
    {
      content['icon'] = text_contents.icon.ICON_QUIZ_DEFAULT;
    }

    const is_quiz = file_name.includes("&quiz") ? true : false;
    content['is_quiz'] = is_quiz;

    content['sub_contents'] = undefined;

    return content;
  }

  displayContents(page_num)
  {
    const contents = this.cur_contents;

    const total_page = parseInt(contents.length / this.count_per_page) + (contents.length % this.count_per_page != 0 ? 1 : 0);
    this.total_page = total_page; //ÎÇòÏ§ëÏóê Ïì∏Í±∞Îùº Ï†ÄÏû•

    let page_contents = [];
    for(let i = this.count_per_page * page_num; i < this.count_per_page; i++)
    {
      page_contents.push(this.cur_contents[i]);
    }

    let contents_message = text_contents.dev_select_category.description;
    for(let i = 0; i < contents.length; i++)
    {
      const cur_content = contents[i];
      let message = text_contents.icon["ICON_NUM_"+i];
      contents_message += message + ")\u1CBC\u1CBC" + cur_content.icon + " " + cur_content.name + "\n\n";
    }

    this.embed.description = contents_message;
  }

  onInteractionCreate(interaction)
  {
    if(!interaction.isButton()) return;

    if(interaction.customId == 'prev') //ÌéòÏù¥ÏßÄ Ïù¥Îèô Ïãú
    {
      if(this.cur_page <= 0) return;

      this.cur_page -= 1;
      this.displayContents(this.cur_page);
      return this;
    }
    
    if(interaction.customId == 'next')
    {
      if(this.cur_page >= this.total_page) return;

      this.cur_page += 1;
      this.displayContents(this.cur_page);
      return this;
    }

    const select_num = parseInt(interaction.customId);
    if(select_num == NaN || select_num < 0 || select_num > 9) return; //1~9Î≤à ÏÇ¨Ïù¥ ÎàåÎ†ÄÏùÑ Í≤ΩÏö∞Îßå

    // Í∑∏ÎÉ• ÌéòÏù¥ÏßÄ Í≥ÑÏÇ∞Ìï¥ÏÑú content Í∞ÄÏ†∏Ïò§Ïûê
    const index = this.count_per_page * this.cur_page + select_num;

    if(index >= this.cur_contents.length)
    {
      console.log(`${index} is not in this.cur_contents`);
    }

    const content = this.cur_contents[index];
    if(content['is_quiz'] == True)
    {
      //Ïñ¥Ï∞®Ìîº Ïó¨Í∏∞ÏÑú ÎßåÎìúÎäî quiz info Îäî ÎÇ¥Í∞Ä ÌïòÎìúÏΩîÎî©Ìï¥ÎèÑ ÎêòÎÑ§
      let quiz_info = {};
      quiz_info['title']  = content['name'];

      quiz_info['description'] = content['description']; //TODO descriptionÏùÄ quizinfo.txt ÏóêÏÑú ÏùΩÏñ¥Ïò§ÎäîÍ±∏Î°ú
      quiz_info['author'] = content['Ï†úÏú°Î≥¥ÎÅî#1916'];
      quiz_info['thumbnail'] = content['https://user-images.githubusercontent.com/28488288/106536426-c48d4300-653b-11eb-97ee-445ba6bced9b.jpg']; //Ïç∏ÎÑ§ÏùºÏùÄ Í∑∏ÎÉ• quizbotÏúºÎ°ú Ìï¥ÎëêÏûê

      quiz_info['quiz_size'] = content['quiz_size']; 

      quiz_info['winner_nickname'] = content['winner_nickname'];

      quiz_info['quiz_path'] = content['content_path'];//dev quizÎäî path ÌïÑÏöî
      quiz_info['quiz_type'] = content['content_path'];//ÏñòÎßå quiz_path ÌïÑÏöî
      return new QuizInfoUI(quiz_info);
    }

    if(content['sub_contents'] != undefined) //ÌïòÏúÑ ÎîîÎ†âÌÑ∞Î¶¨Í∞Ä ÏûàÎã§Î©¥
    {
      return new DevQuizSelectUI(content['sub_contents']);
    }
    
  }

}

//ÌÄ¥Ï¶à Ï†ïÎ≥¥ ÌëúÏãú UI, DevÌÄ¥Ï¶à/UserÌÄ¥Ï¶à Îëò Îã§ ÏÇ¨Ïö©
class QuizInfoUI extends QuizbotUI
{
  constructor(quiz_info)
  {
    super();

    this.quiz_info = quiz_info;

    this.embed = {
      color: 0x87CEEB,
      title: quiz_info['title'],
      description: quiz_info['description'],
      thumbnail: { //ÌÄ¥Ï¶à ÏÑ¨ÎÑ§Ïùº ÌëúÏãú
        url: quiz_info['thumbnail'],
      },
      footer: { //ÌÄ¥Ï¶à Ï†úÏûëÏûê ÌëúÏãú
        text: quiz_info['author'],
        icon_url: 'https://user-images.githubusercontent.com/28488288/208116143-24828069-91e7-4a67-ac69-3bf50a8e1a02.png',
      },
    };

    const quiz_info_comp = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
      .setCustomId('start')
      .setLabel('ÏãúÏûë')
      .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId('scoreboard')
        .setLabel('ÏàúÏúÑÌëú')
        .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId('settings')
        .setLabel('ÏÑ§Ï†ï')
        .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId('back')
        .setLabel('Îí§Î°úÍ∞ÄÍ∏∞')
        .setStyle(ButtonStyle.Secondary),
    )
    this.components = [quiz_info_comp]; //Ïó¨Í∏∞ÏÑúÎäî componentÎ•º Î∞îÍøîÏÑú Ìï¥Ï£ºÏûê
  }

  onInteractionCreate(interaction)
  {
    if(!interaction.isButton()) return;

    if(interaction.customId == 'start') //ÏãúÏûë Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      const guild = interaction.guild;
      const owner = interaction.member; //Ï£ºÏµúÏûê
      return new QuizPlayUI(guild, owner, quiz_info);
    }

    if(interaction.customId == 'scoreboard') //ÏàúÏúÑÌëú Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      
    }

    if(interaction.customId == 'settings') //ÏÑ§Ï†ï Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      
    }
  }
}

//Quiz ÌîåÎ†àÏù¥ UI
class QuizPlayUI extends QuizbotUI
{

  constructor(guild, owner, quiz_info)
  {
    super();

    this.quiz_info = quiz_info;
    this.guild = guild;
    this.owner = owner;

    this.embed = {
      color: 0x87CEEB,
      title: quiz_info['title'],
      description: quiz_info['description'],
      thumbnail: { //ÌÄ¥Ï¶à ÏÑ¨ÎÑ§Ïùº ÌëúÏãú
        url: quiz_info['thumbnail'],
      },
      footer: { //ÌÄ¥Ï¶à Ï†úÏûëÏûê ÌëúÏãú
        text: quiz_info['author'],
        icon_url: 'https://user-images.githubusercontent.com/28488288/208116143-24828069-91e7-4a67-ac69-3bf50a8e1a02.png',
      },
    };

    const quiz_info_comp = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
      .setCustomId('start')
      .setLabel('ÌûåÌä∏')
      .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId('scoreboard')
        .setLabel('Ïä§ÌÇµ')
        .setStyle(ButtonStyle.Secondary),
      new ButtonBuilder()
        .setCustomId('settings')
        .setLabel('Í∑∏ÎßåÌïòÍ∏∞')
        .setStyle(ButtonStyle.Secondary),
    )
    this.components = [quiz_info_comp]; //Ïó¨Í∏∞ÏÑúÎäî componentÎ•º Î∞îÍøîÏÑú Ìï¥Ï£ºÏûê

    this.startQuiz();
  }

  onInteractionCreate(interaction)
  {
    if(!interaction.isButton()) return;

    if(interaction.customId == 'start') //ÏãúÏûë Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      return new QuizPlayUI(quiz_info);
    }

    if(interaction.customId == 'scoreboard') //ÏàúÏúÑÌëú Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      
    }

    if(interaction.customId == 'settings') //ÏÑ§Ï†ï Î≤ÑÌäº ÎàåÎ†ÄÏùÑ ÎñÑ
    {
      
    }
  }

  startQuiz()
  {
    quiz_machine.startQuiz(this.guild, this.quiz_info, this);
  }

}